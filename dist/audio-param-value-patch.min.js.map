{"version":3,"file":"audio-param-value-patch.min.js","sources":["../src/audio-param-value-patch.js"],"sourcesContent":["/* global AudioParam, AudioContext */\n\nfunction getLinearRampToValueAtTime (t, v0, v1, t0, t1) {\n  if (t <= t0) return v0\n  if (t1 <= t) return v1\n\n  var a = (t - t0) / (t1 - t0)\n\n  return v0 + a * (v1 - v0)\n}\n\nfunction getExponentialRampToValueAtTime (t, v0, v1, t0, t1) {\n  if (t <= t0) return v0\n  if (t1 <= t) return v1\n  if (v0 === v1) return v0\n\n  var a = (t - t0) / (t1 - t0)\n\n  return (\n    (v0 > 0 && v1 > 0) || (v0 < 0 && v1 < 0)\n    ? v0 * Math.pow(v1 / v0, a)\n    : 0\n  )\n}\n\nfunction getTargetValueAtTime (t, v0, v1, t0, timeConstant) {\n  return (\n    t <= t0\n    ? v0\n    : v1 + (v0 - v1) * Math.exp((t0 - t) / timeConstant)\n  )\n}\n\nfunction getValueCurveAtTime (t, curve, t0, duration) {\n  if (curve.length === 0) return 0\n\n  var x = (t - t0) / duration\n  var ix = x * (curve.length - 1)\n  var i0 = ix | 0\n  var i1 = i0 + 1\n\n  if (curve.length <= i1) return curve[curve.length - 1]\n\n  var y0 = curve[i0]\n  var y1 = curve[i1]\n  var a = ix % 1\n\n  return y0 + a * (y1 - y0)\n}\n\nfunction findIndex (values, target, compareFn) {\n  if (values.length === 0 || compareFn(target, values[0]) < 0) {\n    return [undefined, 0]\n  }\n  if (compareFn(target, values[values.length - 1]) > 0) {\n    return [values.length - 1, undefined]\n  }\n  return modifiedBinarySearch(values, 0, values.length - 1, target, compareFn)\n}\n\nfunction modifiedBinarySearch (values, start, end, target, compareFn) {\n  if (start > end) return [end, undefined]\n\n  var middle = Math.floor((start + end) / 2)\n  var middleValue = values[middle]\n\n  if (compareFn(middleValue, target) < 0 && values[middle + 1] && compareFn(values[middle + 1], target) > 0) {\n    return [middle, middle + 1]\n  } else if (compareFn(middleValue, target) > 0) {\n    return modifiedBinarySearch(values, start, middle - 1, target, compareFn)\n  } else if (compareFn(middleValue, target) < 0) {\n    return modifiedBinarySearch(values, middle + 1, end, target, compareFn)\n  } else {\n    return [middle]\n  }\n}\n\n// ------------\n\nvar firefoxVersion = false\ntry {\n  firefoxVersion = navigator.userAgent\n    .match(/Firefox\\/([\\d.]+)/)[1]\n    .split('.')\n    .map(function (val) {\n      return parseInt(val)\n    })\n} catch (e) {}\n\nif (firefoxVersion !== false) {\n  AudioParam.prototype._events = []\n  AudioParam.prototype._ctx = null\n\n  var oldSetValueAtTime = AudioParam.prototype.setValueAtTime\n  AudioParam.prototype.setValueAtTime = function (value, time) {\n    var args = Array.from(arguments)\n    if (this._ctx !== null) {\n      this._insertEvent({\n        type: 'setValueAtTime',\n        time: time,\n        value: value,\n        args: args\n      })\n    }\n    return oldSetValueAtTime.apply(this, args)\n  }\n\n  var oldLinearRampToValueAtTime = AudioParam.prototype.linearRampToValueAtTime\n  AudioParam.prototype.linearRampToValueAtTime = function (value, time) {\n    var args = Array.from(arguments)\n    if (this._ctx !== null) {\n      this._insertEvent({\n        type: 'linearRampToValueAtTime',\n        time: time,\n        value: value,\n        args: args\n      })\n    }\n    return oldLinearRampToValueAtTime.apply(this, args)\n  }\n\n  var oldExponentialRampToValueAtTime = AudioParam.prototype.exponentialRampToValueAtTime\n  AudioParam.prototype.exponentialRampToValueAtTime = function (value, time) {\n    var args = Array.from(arguments)\n    if (this._ctx !== null) {\n      this._insertEvent({\n        type: 'exponentialRampToValueAtTime',\n        time: time,\n        value: value,\n        args: args\n      })\n    }\n    return oldExponentialRampToValueAtTime.apply(this, args)\n  }\n\n  var oldSetTargetAtTime = AudioParam.prototype.setTargetAtTime\n  AudioParam.prototype.setTargetAtTime = function (value, time, timeConstant) {\n    var args = Array.from(arguments)\n    if (this._ctx !== null) {\n      this._insertEvent({\n        type: 'setTargetAtTime',\n        time: time,\n        value: value,\n        timeConstant: timeConstant,\n        args: args\n      })\n    }\n    return oldSetTargetAtTime.apply(this, args)\n  }\n\n  var oldSetValueCurveAtTime = AudioParam.prototype.setValueCurveAtTime\n  AudioParam.prototype.setValueCurveAtTime = function (curve, time, duration) {\n    var args = Array.from(arguments)\n    if (this._ctx !== null) {\n      this._insertEvent({\n        type: 'setValueCurveAtTime',\n        time: time,\n        curve: curve,\n        duration: duration,\n        args: args\n      })\n    }\n    return oldSetValueCurveAtTime.apply(this, args)\n  }\n\n  var oldCancelScheduledValues = AudioParam.prototype.cancelScheduledValues\n  AudioParam.prototype.cancelScheduledValues = function (time) {\n    if (this._ctx !== null) {\n      this._events = this._events.filter(function (eventItem) {\n        return eventItem.time < time\n      })\n    }\n    return oldCancelScheduledValues.apply(this, Array.from(arguments))\n  }\n\n  AudioParam.prototype._insertEvent = function (eventItem) {\n    var time = eventItem.time\n    var events = this._events = JSON.parse(JSON.stringify(this._events))\n    var replace = 0\n    var i, imax\n\n    if (events.length === 0 || events[events.length - 1].time < time) {\n      events.push(eventItem)\n    } else {\n      for (i = 0, imax = events.length; i < imax; i++) {\n        if (events[i].time === time && events[i].type === eventItem.type) {\n          replace = 1\n          break\n        }\n        if (time < events[i].time) {\n          break\n        }\n      }\n      events.splice(i, replace, eventItem)\n    }\n  }\n\n  AudioParam.prototype._getValueAtTime = function (time) {\n    var events = this._events\n    var value = this.defaultValue\n    var i, imax\n    var e0, e1, t0\n\n    // TODO: initialize 'target' and 'compareFn' in the constructor to avoid the garbage collector.\n    var idx = findIndex(events, { time: time }, function (a, b) { return a.time - b.time })\n    var pIdx = idx[0]\n    var nIdx = idx[1]\n\n    if (idx.length === 1 || pIdx !== undefined) {\n      i = pIdx\n    } else if (nIdx !== undefined) {\n      i = nIdx\n    }\n\n    for (i = Math.max(0, i - 1), imax = events.length; i < imax; i++) {\n      e0 = events[i]\n      e1 = events[i + 1]\n      t0 = Math.min(time, e1 ? e1.time : time)\n\n      if (time < e0.time) {\n        break\n      }\n\n      switch (e0.type) {\n        case 'setValueAtTime':\n        case 'linearRampToValueAtTime':\n        case 'exponentialRampToValueAtTime':\n          value = e0.value\n          break\n        case 'setTargetAtTime':\n          value = getTargetValueAtTime(t0, value, e0.value, e0.time, e0.timeConstant)\n          break\n        case 'setValueCurveAtTime':\n          value = getValueCurveAtTime(t0, e0.curve, e0.time, e0.duration)\n          break\n      }\n\n      if (e1) {\n        switch (e1.type) {\n          case 'linearRampToValueAtTime':\n            value = getLinearRampToValueAtTime(t0, value, e1.value, e0.time, e1.time)\n            break\n          case 'exponentialRampToValueAtTime':\n            value = getExponentialRampToValueAtTime(t0, value, e1.value, e0.time, e1.time)\n            break\n        }\n      }\n    }\n\n    return value\n  }\n\n  // -------------------\n\n  var descriptor = Object.getOwnPropertyDescriptor(AudioParam.prototype, 'value')\n\n  var oldSet = descriptor.set\n  descriptor.set = function (value) {\n    console.log('set')\n    if (this._ctx === null) {\n      oldSet.apply(this, Array.from(arguments))\n    } else {\n      this.setValueAtTime(value, this._ctx.currentTime)\n    }\n  }\n\n  var oldGet = descriptor.get\n  descriptor.get = function () {\n    return (\n      this._ctx === null\n      ? oldGet.apply(this, Array.from(arguments))\n      : this._getValueAtTime(this._ctx.currentTime)\n    )\n  }\n\n  Object.defineProperty(AudioParam.prototype, 'value', descriptor)\n\n  // -------------------\n\n  var oldCreateGain = AudioContext.prototype.createGain\n  AudioContext.prototype.createGain = function () {\n    var gain = oldCreateGain.apply(this, Array.from(arguments))\n    gain.gain._ctx = this\n    return gain\n  }\n\n  var oldCreateOscillator = AudioContext.prototype.createOscillator\n  AudioContext.prototype.createOscillator = function () {\n    var oscillator = oldCreateOscillator.apply(this, Array.from(arguments))\n    oscillator.frequency._ctx = this\n    oscillator.detune._ctx = this\n    return oscillator\n  }\n}\n"],"names":["getLinearRampToValueAtTime","t","v0","v1","t0","t1","getExponentialRampToValueAtTime","a","Math","pow","getTargetValueAtTime","timeConstant","exp","getValueCurveAtTime","curve","duration","length","ix","i0","i1","y0","findIndex","values","target","compareFn","undefined","modifiedBinarySearch","start","end","middle","floor","middleValue","firefoxVersion","navigator","userAgent","match","split","map","val","parseInt","e","AudioParam","prototype","_events","_ctx","oldSetValueAtTime","setValueAtTime","value","time","args","Array","from","arguments","this","_insertEvent","type","apply","oldLinearRampToValueAtTime","linearRampToValueAtTime","oldExponentialRampToValueAtTime","exponentialRampToValueAtTime","oldSetTargetAtTime","setTargetAtTime","oldSetValueCurveAtTime","setValueCurveAtTime","oldCancelScheduledValues","cancelScheduledValues","filter","eventItem","i","imax","events","JSON","parse","stringify","replace","push","splice","_getValueAtTime","e0","e1","defaultValue","idx","b","pIdx","nIdx","max","min","descriptor","Object","getOwnPropertyDescriptor","oldSet","set","console","log","currentTime","oldGet","get","defineProperty","oldCreateGain","AudioContext","createGain","gain","oldCreateOscillator","createOscillator","oscillator","frequency","detune"],"mappings":";AAEA,SAASA,2BAA4BC,EAAGC,EAAIC,EAAIC,EAAIC,GAClD,OAAIJ,GAAKG,EAAWF,EAChBG,GAAMJ,EAAUE,EAIbD,GAFED,EAAIG,IAAOC,EAAKD,IAERD,EAAKD,GAGxB,SAASI,gCAAiCL,EAAGC,EAAIC,EAAIC,EAAIC,GACvD,GAAIJ,GAAKG,EAAI,OAAOF,EACpB,GAAIG,GAAMJ,EAAG,OAAOE,EACpB,GAAID,IAAOC,EAAI,OAAOD,EAEtB,IAAIK,GAAKN,EAAIG,IAAOC,EAAKD,GAEzB,OACGF,EAAK,GAAKC,EAAK,GAAOD,EAAK,GAAKC,EAAK,EACpCD,EAAKM,KAAKC,IAAIN,EAAKD,EAAIK,GACvB,EAIN,SAASG,qBAAsBT,EAAGC,EAAIC,EAAIC,EAAIO,GAC5C,OACEV,GAAKG,EACHF,EACAC,GAAMD,EAAKC,GAAMK,KAAKI,KAAKR,EAAKH,GAAKU,GAI3C,SAASE,oBAAqBZ,EAAGa,EAAOV,EAAIW,GAC1C,GAAqB,IAAjBD,EAAME,OAAc,OAAO,EAE/B,IACIC,GADKhB,EAAIG,GAAMW,GACLD,EAAME,OAAS,GACzBE,EAAU,EAALD,EACLE,EAAKD,EAAK,EAEd,GAAIJ,EAAME,QAAUG,EAAI,OAAOL,EAAMA,EAAME,OAAS,GAEpD,IAAII,EAAKN,EAAMI,GAIf,OAAOE,EAFCH,EAAK,GADJH,EAAMK,GAGOC,GAGxB,SAASC,UAAWC,EAAQC,EAAQC,GAClC,OAAsB,IAAlBF,EAAON,QAAgBQ,EAAUD,EAAQD,EAAO,IAAM,QAChDG,EAAW,GAEjBD,EAAUD,EAAQD,EAAOA,EAAON,OAAS,IAAM,GACzCM,EAAON,OAAS,OAAGS,GAEtBC,qBAAqBJ,EAAQ,EAAGA,EAAON,OAAS,EAAGO,EAAQC,GAGpE,SAASE,qBAAsBJ,EAAQK,EAAOC,EAAKL,EAAQC,GACzD,GAAIG,EAAQC,EAAK,OAAQA,OAAKH,GAE9B,IAAII,EAASrB,KAAKsB,OAAOH,EAAQC,GAAO,GACpCG,EAAcT,EAAOO,GAEzB,OAAIL,EAAUO,EAAaR,GAAU,GAAKD,EAAOO,EAAS,IAAML,EAAUF,EAAOO,EAAS,GAAIN,GAAU,GAC9FM,EAAQA,EAAS,GAChBL,EAAUO,EAAaR,GAAU,EACnCG,qBAAqBJ,EAAQK,EAAOE,EAAS,EAAGN,EAAQC,GACtDA,EAAUO,EAAaR,GAAU,EACnCG,qBAAqBJ,EAAQO,EAAS,EAAGD,EAAKL,EAAQC,IAErDK,GAMZ,IAAIG,gBAAiB,EACrB,IACEA,eAAiBC,UAAUC,UACxBC,MAAM,qBAAqB,GAC3BC,MAAM,KACNC,IAAI,SAAUC,GACb,OAAOC,SAASD,KAEpB,MAAOE,IAET,IAAuB,IAAnBR,eAA0B,CAC5BS,WAAWC,UAAUC,WACrBF,WAAWC,UAAUE,KAAO,KAE5B,IAAIC,kBAAoBJ,WAAWC,UAAUI,eAC7CL,WAAWC,UAAUI,eAAiB,SAAUC,EAAOC,GACrD,IAAIC,EAAOC,MAAMC,KAAKC,WAStB,OARkB,OAAdC,KAAKT,MACPS,KAAKC,cACHC,KAAM,iBACNP,KAAMA,EACND,MAAOA,EACPE,KAAMA,IAGHJ,kBAAkBW,MAAMH,KAAMJ,IAGvC,IAAIQ,2BAA6BhB,WAAWC,UAAUgB,wBACtDjB,WAAWC,UAAUgB,wBAA0B,SAAUX,EAAOC,GAC9D,IAAIC,EAAOC,MAAMC,KAAKC,WAStB,OARkB,OAAdC,KAAKT,MACPS,KAAKC,cACHC,KAAM,0BACNP,KAAMA,EACND,MAAOA,EACPE,KAAMA,IAGHQ,2BAA2BD,MAAMH,KAAMJ,IAGhD,IAAIU,gCAAkClB,WAAWC,UAAUkB,6BAC3DnB,WAAWC,UAAUkB,6BAA+B,SAAUb,EAAOC,GACnE,IAAIC,EAAOC,MAAMC,KAAKC,WAStB,OARkB,OAAdC,KAAKT,MACPS,KAAKC,cACHC,KAAM,+BACNP,KAAMA,EACND,MAAOA,EACPE,KAAMA,IAGHU,gCAAgCH,MAAMH,KAAMJ,IAGrD,IAAIY,mBAAqBpB,WAAWC,UAAUoB,gBAC9CrB,WAAWC,UAAUoB,gBAAkB,SAAUf,EAAOC,EAAMrC,GAC5D,IAAIsC,EAAOC,MAAMC,KAAKC,WAUtB,OATkB,OAAdC,KAAKT,MACPS,KAAKC,cACHC,KAAM,kBACNP,KAAMA,EACND,MAAOA,EACPpC,aAAcA,EACdsC,KAAMA,IAGHY,mBAAmBL,MAAMH,KAAMJ,IAGxC,IAAIc,uBAAyBtB,WAAWC,UAAUsB,oBAClDvB,WAAWC,UAAUsB,oBAAsB,SAAUlD,EAAOkC,EAAMjC,GAChE,IAAIkC,EAAOC,MAAMC,KAAKC,WAUtB,OATkB,OAAdC,KAAKT,MACPS,KAAKC,cACHC,KAAM,sBACNP,KAAMA,EACNlC,MAAOA,EACPC,SAAUA,EACVkC,KAAMA,IAGHc,uBAAuBP,MAAMH,KAAMJ,IAG5C,IAAIgB,yBAA2BxB,WAAWC,UAAUwB,sBACpDzB,WAAWC,UAAUwB,sBAAwB,SAAUlB,GAMrD,OALkB,OAAdK,KAAKT,OACPS,KAAKV,QAAUU,KAAKV,QAAQwB,OAAO,SAAUC,GAC3C,OAAOA,EAAUpB,KAAOA,KAGrBiB,yBAAyBT,MAAMH,KAAMH,MAAMC,KAAKC,aAGzDX,WAAWC,UAAUY,aAAe,SAAUc,GAC5C,IAGIC,EAAGC,EAHHtB,EAAOoB,EAAUpB,KACjBuB,EAASlB,KAAKV,QAAU6B,KAAKC,MAAMD,KAAKE,UAAUrB,KAAKV,UACvDgC,EAAU,EAGd,GAAsB,IAAlBJ,EAAOvD,QAAgBuD,EAAOA,EAAOvD,OAAS,GAAGgC,KAAOA,EAC1DuB,EAAOK,KAAKR,OACP,CACL,IAAKC,EAAI,EAAGC,EAAOC,EAAOvD,OAAQqD,EAAIC,EAAMD,IAAK,CAC/C,GAAIE,EAAOF,GAAGrB,OAASA,GAAQuB,EAAOF,GAAGd,OAASa,EAAUb,KAAM,CAChEoB,EAAU,EACV,MAEF,GAAI3B,EAAOuB,EAAOF,GAAGrB,KACnB,MAGJuB,EAAOM,OAAOR,EAAGM,EAASP,KAI9B3B,WAAWC,UAAUoC,gBAAkB,SAAU9B,GAC/C,IAEIqB,EAAGC,EACHS,EAAIC,EAAI5E,EAHRmE,EAASlB,KAAKV,QACdI,EAAQM,KAAK4B,aAKbC,EAAM7D,UAAUkD,GAAUvB,KAAMA,GAAQ,SAAUzC,EAAG4E,GAAK,OAAO5E,EAAEyC,KAAOmC,EAAEnC,OAC5EoC,EAAOF,EAAI,GACXG,EAAOH,EAAI,GAQf,IANmB,IAAfA,EAAIlE,aAAyBS,IAAT2D,EACtBf,EAAIe,OACc3D,IAAT4D,IACThB,EAAIgB,GAGDhB,EAAI7D,KAAK8E,IAAI,EAAGjB,EAAI,GAAIC,EAAOC,EAAOvD,OAAQqD,EAAIC,IACrDS,EAAKR,EAAOF,GACZW,EAAKT,EAAOF,EAAI,GAChBjE,EAAKI,KAAK+E,IAAIvC,EAAMgC,EAAKA,EAAGhC,KAAOA,KAE/BA,EAAO+B,EAAG/B,OAL6CqB,IAAK,CAShE,OAAQU,EAAGxB,MACT,IAAK,iBACL,IAAK,0BACL,IAAK,+BACHR,EAAQgC,EAAGhC,MACX,MACF,IAAK,kBACHA,EAAQrC,qBAAqBN,EAAI2C,EAAOgC,EAAGhC,MAAOgC,EAAG/B,KAAM+B,EAAGpE,cAC9D,MACF,IAAK,sBACHoC,EAAQlC,oBAAoBT,EAAI2E,EAAGjE,MAAOiE,EAAG/B,KAAM+B,EAAGhE,UAI1D,GAAIiE,EACF,OAAQA,EAAGzB,MACT,IAAK,0BACHR,EAAQ/C,2BAA2BI,EAAI2C,EAAOiC,EAAGjC,MAAOgC,EAAG/B,KAAMgC,EAAGhC,MACpE,MACF,IAAK,+BACHD,EAAQzC,gCAAgCF,EAAI2C,EAAOiC,EAAGjC,MAAOgC,EAAG/B,KAAMgC,EAAGhC,OAMjF,OAAOD,GAKT,IAAIyC,WAAaC,OAAOC,yBAAyBjD,WAAWC,UAAW,SAEnEiD,OAASH,WAAWI,IACxBJ,WAAWI,IAAM,SAAU7C,GACzB8C,QAAQC,IAAI,OACM,OAAdzC,KAAKT,KACP+C,OAAOnC,MAAMH,KAAMH,MAAMC,KAAKC,YAE9BC,KAAKP,eAAeC,EAAOM,KAAKT,KAAKmD,cAIzC,IAAIC,OAASR,WAAWS,IACxBT,WAAWS,IAAM,WACf,OACgB,OAAd5C,KAAKT,KACHoD,OAAOxC,MAAMH,KAAMH,MAAMC,KAAKC,YAC9BC,KAAKyB,gBAAgBzB,KAAKT,KAAKmD,cAIrCN,OAAOS,eAAezD,WAAWC,UAAW,QAAS8C,YAIrD,IAAIW,cAAgBC,aAAa1D,UAAU2D,WAC3CD,aAAa1D,UAAU2D,WAAa,WAClC,IAAIC,EAAOH,cAAc3C,MAAMH,KAAMH,MAAMC,KAAKC,YAEhD,OADAkD,EAAKA,KAAK1D,KAAOS,KACViD,GAGT,IAAIC,oBAAsBH,aAAa1D,UAAU8D,iBACjDJ,aAAa1D,UAAU8D,iBAAmB,WACxC,IAAIC,EAAaF,oBAAoB/C,MAAMH,KAAMH,MAAMC,KAAKC,YAG5D,OAFAqD,EAAWC,UAAU9D,KAAOS,KAC5BoD,EAAWE,OAAO/D,KAAOS,KAClBoD"}