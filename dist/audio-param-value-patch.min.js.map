{"version":3,"file":"audio-param-value-patch.min.js","sources":["../src/audio-param-value-patch.js"],"sourcesContent":["/* global AudioParam, AudioContext */\r\n\r\nfunction getLinearRampToValueAtTime (t, v0, v1, t0, t1) {\r\n  if (t <= t0) return v0\r\n  if (t1 <= t) return v1\r\n\r\n  var a = (t - t0) / (t1 - t0)\r\n\r\n  return v0 + a * (v1 - v0)\r\n}\r\n\r\nfunction getExponentialRampToValueAtTime (t, v0, v1, t0, t1) {\r\n  if (t <= t0) return v0\r\n  if (t1 <= t) return v1\r\n  if (v0 === v1) return v0\r\n\r\n  var a = (t - t0) / (t1 - t0)\r\n\r\n  return (\r\n    (v0 > 0 && v1 > 0) || (v0 < 0 && v1 < 0)\r\n    ? v0 * Math.pow(v1 / v0, a)\r\n    : 0\r\n  )\r\n}\r\n\r\nfunction getTargetValueAtTime (t, v0, v1, t0, timeConstant) {\r\n  return (\r\n    t <= t0\r\n    ? v0\r\n    : v1 + (v0 - v1) * Math.exp((t0 - t) / timeConstant)\r\n  )\r\n}\r\n\r\nfunction getValueCurveAtTime (t, curve, t0, duration) {\r\n  if (curve.length === 0) return 0\r\n\r\n  var x = (t - t0) / duration\r\n  var ix = x * (curve.length - 1)\r\n  var i0 = ix | 0\r\n  var i1 = i0 + 1\r\n\r\n  if (curve.length <= i1) return curve[curve.length - 1]\r\n\r\n  var y0 = curve[i0]\r\n  var y1 = curve[i1]\r\n  var a = ix % 1\r\n\r\n  return y0 + a * (y1 - y0)\r\n}\r\n\r\nfunction findIndex (values, target, compareFn) {\r\n  if (values.length === 0 || compareFn(target, values[0]) < 0) {\r\n    return [undefined, 0]\r\n  }\r\n  if (compareFn(target, values[values.length - 1]) > 0) {\r\n    return [values.length - 1, undefined]\r\n  }\r\n  return modifiedBinarySearch(values, 0, values.length - 1, target, compareFn)\r\n}\r\n\r\nfunction modifiedBinarySearch (values, start, end, target, compareFn) {\r\n  if (start > end) return [end, undefined]\r\n\r\n  var middle = Math.floor((start + end) / 2)\r\n  var middleValue = values[middle]\r\n\r\n  if (compareFn(middleValue, target) < 0 && values[middle + 1] && compareFn(values[middle + 1], target) > 0) {\r\n    return [middle, middle + 1]\r\n  } else if (compareFn(middleValue, target) > 0) {\r\n    return modifiedBinarySearch(values, start, middle - 1, target, compareFn)\r\n  } else if (compareFn(middleValue, target) < 0) {\r\n    return modifiedBinarySearch(values, middle + 1, end, target, compareFn)\r\n  } else {\r\n    return [middle]\r\n  }\r\n}\r\n\r\n// ------------\r\n\r\nvar firefoxVersion = false\r\ntry {\r\n  firefoxVersion = navigator.userAgent\r\n    .match(/Firefox\\/([\\d.]+)/)[1]\r\n    .split('.')\r\n    .map(function (val) {\r\n      return parseInt(val)\r\n    })\r\n} catch (e) {}\r\n\r\nif (firefoxVersion !== false) {\r\n  AudioParam.prototype._events = []\r\n  AudioParam.prototype._ctx = null\r\n\r\n  var oldSetValueAtTime = AudioParam.prototype.setValueAtTime\r\n  AudioParam.prototype.setValueAtTime = function (value, time) {\r\n    var args = Array.from(arguments)\r\n    if (this._ctx !== null) {\r\n      this._insertEvent({\r\n        type: 'setValueAtTime',\r\n        time: time,\r\n        value: value,\r\n        args: args\r\n      })\r\n    }\r\n    return oldSetValueAtTime.apply(this, args)\r\n  }\r\n\r\n  var oldLinearRampToValueAtTime = AudioParam.prototype.linearRampToValueAtTime\r\n  AudioParam.prototype.linearRampToValueAtTime = function (value, time) {\r\n    var args = Array.from(arguments)\r\n    if (this._ctx !== null) {\r\n      this._insertEvent({\r\n        type: 'linearRampToValueAtTime',\r\n        time: time,\r\n        value: value,\r\n        args: args\r\n      })\r\n    }\r\n    return oldLinearRampToValueAtTime.apply(this, args)\r\n  }\r\n\r\n  var oldExponentialRampToValueAtTime = AudioParam.prototype.exponentialRampToValueAtTime\r\n  AudioParam.prototype.exponentialRampToValueAtTime = function (value, time) {\r\n    var args = Array.from(arguments)\r\n    if (this._ctx !== null) {\r\n      this._insertEvent({\r\n        type: 'exponentialRampToValueAtTime',\r\n        time: time,\r\n        value: value,\r\n        args: args\r\n      })\r\n    }\r\n    return oldExponentialRampToValueAtTime.apply(this, args)\r\n  }\r\n\r\n  var oldSetTargetAtTime = AudioParam.prototype.setTargetAtTime\r\n  AudioParam.prototype.setTargetAtTime = function (value, time, timeConstant) {\r\n    var args = Array.from(arguments)\r\n    if (this._ctx !== null) {\r\n      this._insertEvent({\r\n        type: 'setTargetAtTime',\r\n        time: time,\r\n        value: value,\r\n        timeConstant: timeConstant,\r\n        args: args\r\n      })\r\n    }\r\n    return oldSetTargetAtTime.apply(this, args)\r\n  }\r\n\r\n  var oldSetValueCurveAtTime = AudioParam.prototype.setValueCurveAtTime\r\n  AudioParam.prototype.setValueCurveAtTime = function (curve, time, duration) {\r\n    var args = Array.from(arguments)\r\n    if (this._ctx !== null) {\r\n      this._insertEvent({\r\n        type: 'setValueCurveAtTime',\r\n        time: time,\r\n        curve: curve,\r\n        duration: duration,\r\n        args: args\r\n      })\r\n    }\r\n    return oldSetValueCurveAtTime.apply(this, args)\r\n  }\r\n\r\n  var oldCancelScheduledValues = AudioParam.prototype.cancelScheduledValues\r\n  AudioParam.prototype.cancelScheduledValues = function (time) {\r\n    if (this._ctx !== null) {\r\n      this._events = this._events.filter(function (eventItem) {\r\n        return eventItem.time < time\r\n      })\r\n    }\r\n    return oldCancelScheduledValues.apply(this, Array.from(arguments))\r\n  }\r\n\r\n  AudioParam.prototype._insertEvent = function (eventItem) {\r\n    var time = eventItem.time\r\n    var events = this._events = JSON.parse(JSON.stringify(this._events))\r\n    var replace = 0\r\n    var i, imax\r\n\r\n    if (events.length === 0 || events[events.length - 1].time < time) {\r\n      events.push(eventItem)\r\n    } else {\r\n      for (i = 0, imax = events.length; i < imax; i++) {\r\n        if (events[i].time === time && events[i].type === eventItem.type) {\r\n          replace = 1\r\n          break\r\n        }\r\n        if (time < events[i].time) {\r\n          break\r\n        }\r\n      }\r\n      events.splice(i, replace, eventItem)\r\n    }\r\n  }\r\n\r\n  AudioParam.prototype._getValueAtTime = function (time) {\r\n    var events = this._events\r\n    var value = this.defaultValue\r\n    var i, imax\r\n    var e0, e1, t0\r\n\r\n    // TODO: initialize 'target' and 'compareFn' in the constructor to avoid the garbage collector.\r\n    var idx = findIndex(events, { time: time }, function (a, b) { return a.time - b.time })\r\n    var pIdx = idx[0]\r\n    var nIdx = idx[1]\r\n\r\n    if (idx.length === 1 || pIdx !== undefined) {\r\n      i = pIdx\r\n    } else if (nIdx !== undefined) {\r\n      i = nIdx\r\n    }\r\n\r\n    for (i = Math.max(0, i - 1), imax = events.length; i < imax; i++) {\r\n      e0 = events[i]\r\n      e1 = events[i + 1]\r\n      t0 = Math.min(time, e1 ? e1.time : time)\r\n\r\n      if (time < e0.time) {\r\n        break\r\n      }\r\n\r\n      switch (e0.type) {\r\n        case 'setValueAtTime':\r\n        case 'linearRampToValueAtTime':\r\n        case 'exponentialRampToValueAtTime':\r\n          value = e0.value\r\n          break\r\n        case 'setTargetAtTime':\r\n          value = getTargetValueAtTime(t0, value, e0.value, e0.time, e0.timeConstant)\r\n          break\r\n        case 'setValueCurveAtTime':\r\n          value = getValueCurveAtTime(t0, e0.curve, e0.time, e0.duration)\r\n          break\r\n      }\r\n\r\n      if (e1) {\r\n        switch (e1.type) {\r\n          case 'linearRampToValueAtTime':\r\n            value = getLinearRampToValueAtTime(t0, value, e1.value, e0.time, e1.time)\r\n            break\r\n          case 'exponentialRampToValueAtTime':\r\n            value = getExponentialRampToValueAtTime(t0, value, e1.value, e0.time, e1.time)\r\n            break\r\n        }\r\n      }\r\n    }\r\n\r\n    return value\r\n  }\r\n\r\n  // -------------------\r\n\r\n  var descriptor = Object.getOwnPropertyDescriptor(AudioParam.prototype, 'value')\r\n\r\n  var oldSet = descriptor.set\r\n  descriptor.set = function (value) {\r\n    console.log('set')\r\n    if (this._ctx === null) {\r\n      oldSet.apply(this, Array.from(arguments))\r\n    } else {\r\n      this.setValueAtTime(value, this._ctx.currentTime)\r\n    }\r\n  }\r\n\r\n  var oldGet = descriptor.get\r\n  descriptor.get = function () {\r\n    return (\r\n      this._ctx === null\r\n      ? oldGet.apply(this, Array.from(arguments))\r\n      : this._getValueAtTime(this._ctx.currentTime)\r\n    )\r\n  }\r\n\r\n  Object.defineProperty(AudioParam.prototype, 'value', descriptor)\r\n\r\n  // -------------------\r\n\r\n  var oldCreateGain = AudioContext.prototype.createGain\r\n  AudioContext.prototype.createGain = function () {\r\n    var gain = oldCreateGain.apply(this, Array.from(arguments))\r\n    gain.gain._ctx = this\r\n    return gain\r\n  }\r\n\r\n  var oldCreateOscillator = AudioContext.prototype.createOscillator\r\n  AudioContext.prototype.createOscillator = function () {\r\n    var oscillator = oldCreateOscillator.apply(this, Array.from(arguments))\r\n    oscillator.frequency._ctx = this\r\n    oscillator.detune._ctx = this\r\n    return oscillator\r\n  }\r\n}\r\n"],"names":["getLinearRampToValueAtTime","t","v0","v1","t0","t1","getExponentialRampToValueAtTime","a","Math","pow","getTargetValueAtTime","timeConstant","exp","getValueCurveAtTime","curve","duration","length","ix","i0","i1","y0","findIndex","values","target","compareFn","undefined","modifiedBinarySearch","start","end","middle","floor","middleValue","firefoxVersion","navigator","userAgent","match","split","map","val","parseInt","e","AudioParam","prototype","_events","_ctx","oldSetValueAtTime","setValueAtTime","value","time","args","Array","from","arguments","this","_insertEvent","type","apply","oldLinearRampToValueAtTime","linearRampToValueAtTime","oldExponentialRampToValueAtTime","exponentialRampToValueAtTime","oldSetTargetAtTime","setTargetAtTime","oldSetValueCurveAtTime","setValueCurveAtTime","oldCancelScheduledValues","cancelScheduledValues","filter","eventItem","i","imax","events","JSON","parse","stringify","replace","push","splice","_getValueAtTime","e0","e1","defaultValue","idx","b","pIdx","nIdx","max","min","descriptor","Object","getOwnPropertyDescriptor","oldSet","set","console","log","currentTime","oldGet","get","defineProperty","oldCreateGain","AudioContext","createGain","gain","oldCreateOscillator","createOscillator","oscillator","frequency","detune"],"mappings":"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"}